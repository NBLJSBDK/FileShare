<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no"/>
  <title>FileShare</title>
  <link rel="stylesheet" href="/res/css/mdui.min.css"/>
  <script src="/res/js/mdui.min.js"></script>
  <script src="/res/js/download.js"></script>
  <!--<script src="./res/js/jquery-3.3.1.min.js"></script>-->
</head>
<body class="mdui-theme-primary-indigo mdui-theme-accent-pink mdui-appbar-with-toolbar">
<!-- appbar -->
<div class="mdui-appbar mdui-appbar-fixed">
  <div class="mdui-toolbar mdui-color-theme">
    <a class="mdui-typo-headline">FileShare</a>
      </div>
</div>
<iframe name='hidden_frame' id="hidden_frame" style="display:none" onload="iframeLoad(this);"></iframe>
<iframe name='hidden_frame_fileupload' id="hidden_frame_fileupload" style="display:none" onload="uploadfinish(this);"></iframe>
<ul class="mdui-list" id="filelist">
</ul>
<div class="mdui-dialog" id="progressDialog" style="padding:20px">
  
  <div>请稍候...</div>
  <br/>
  <div class="mdui-progress">
  <div class="mdui-progress-indeterminate"></div>
</div>
</div>
<form method="POST" target="hidden_frame_fileupload" id="form_upload" action="upload" enctype="multipart/form-data">
<input onchange="doupload();" type="file" name="uploadfile" id="file_upload" style="display:none">
<input type="submit" id="file_submit" style="display:none"/>
</form>
<button class="mdui-fab mdui-fab-fixed mdui-ripple mdui-color-theme-accent" onclick="document.getElementById('file_upload').click();"><i class="mdui-icon material-icons">file_upload</i></button>
<script language="javascript">
//alert("ok1");
var pd=new mdui.Dialog("#progressDialog",{modal: true});
//var path="/";
var need=false;
var needupload=false;
var items = new Array();
function dogetfiles(fname){  
need=true;
     var iframe=document.getElementById("hidden_frame");
     //alert(iframe);
     iframe.setAttribute("src","/getfiles?path="+fname,0);
     
      //alert(iframe.contentWindow.document.doc.body.innerHTML)
}
//alert("ok2")
function doupload()
{
try{
pd.open();
var sub = document.getElementById("file_submit");
needupload=true;
sub.click()
}catch(e)
{alert(e)}
}
function uploadfinish(iframe)
{
try{
pd.close();
if(needupload)
{
var doc = iframe.contentWindow.document;
var html = doc.body.innerHTML;
if(html=="ok")
{
mdui.alert("上传成功",function(){location.reload()});
}else
{
mdui.alert(html,function(){location.reload()});
}}
needupload=false
}catch(e)
{alert(e)}
}
function clear() {
try{
var list=document.getElementById('filelist');
                for (var i  in items) {
                      list.removeChild(items[i]);

                }
                items=new Array();
}catch(err)
{
alert(err);
}
}
//alert("ok3")
function enterdir(name)
{
if(name!=".")
{
clear();
pd.open();
try{
dogetfiles(name);
}catch(err)
{
alert(err);
}
}
}
//alert("ok4")
function cutString(str, len) {
 //length属性读出来的汉字长度为1
 if(str.length*2 <= len) {
  return str;
 }
 var strlen = 0;
 var s = "";
 for(var i = 0;i < str.length; i++) {
  s = s + str.charAt(i);
  if (str.charCodeAt(i) > 128) {
   strlen = strlen + 2;
   if(strlen >= len){
    return s.substring(0,s.length-1) + "...";
   }
  } else {
   strlen = strlen + 1;
   if(strlen >= len){
    return s.substring(0,s.length-2) + "...";
   }
  }
 }
 return s;
}
//alert("ok5")

function addfile(filename,isdir){
var item = document.createElement('li');
items.push(item);
item.setAttribute("class","mdui-list-item mdui-ripple");
var a=document.createElement('i');
a.setAttribute("class","mdui-list-item-avatar mdui-icon material-icons");
if(isdir)
{
a.innerText="folder";
}else{
a.innerText="insert_drive_file"
}
document.getElementById("filelist").appendChild(item);
item.appendChild(a);
var b=document.createElement('div');
b.setAttribute("class","mdui-list-item-content");
b.innerText=cutString(filename,32);
item.appendChild(b);
var infobtn=document.createElement("button");
infobtn.setAttribute("class","mdui-btn mdui-btn-icon mdui-ripple");
var infoicon=document.createElement("i");
infoicon.setAttribute("class","mdui-icon material-icons");
infoicon.innerText="info";
infobtn.appendChild(infoicon);
item.appendChild(infobtn);
if(isdir)
{
b.onclick=function(){enterdir(filename)};
}else{
b.onclick=function(){
mdui.snackbar({
  message: '下载即将开始'
});
location.href="http://"+window.location.host+"/download?path="+filename;
}
infobtn.onclick=function(){mdui.alert("开发中...")};
}
}
//alert("ok6")
function count(o){
                var t = typeof o;
                if(t == 'string'){
                        return o.length;
                }else if(t == 'object'){
                        var n = 0;
                        for(var i in o){
                                n++;
                        }
                        return n;
                }
                return false;
        }
//alert("ok8")

function iframeLoad(iframe){
if(need)
{
need=false;
try{
var doc = iframe.contentWindow.document;
var html = doc.body.innerHTML;
//alert(html);
var files=html.split("\n");
if(files[0].split(" ")[0]=="ok")
{
var dirlen=parseInt(files[0].split(" ")[1]);
var len=count(files);
for(var i=1;i<=dirlen;i++)
{
addfile(files[i],true);
}
for(var i=dirlen+1;i<len;i++)
{
addfile(files[i],false);
}
}else{
mdui.alert("错误:不能列出文件："+files[0].split(" ")[1]+"如果您在多次点击确定后仍有这样的提示，请联系开服端在FileShare的APP上修改起始路径。",function(){location.reload()});
}
pd.close();
}catch(err)
{
alert(err);
}
}
}

try{
dogetfiles("/");
}catch(err)
{
alert(err);
}
</script>
</body>
</html>